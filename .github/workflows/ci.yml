name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed apps
        id: changes
        run: |
          APPS=""
          for app in app1 app2 app3 app4; do
            if git diff --name-only HEAD~1 HEAD | grep "^apps/$app/" > /dev/null; then
              APPS="$APPS $app"
            fi
          done
          echo "apps=$APPS" >> $GITHUB_OUTPUT

      - name: Enforce VERSION update
        run: |
          for app in ${{ steps.changes.outputs.apps }}; do
            if git diff --name-only HEAD~1 HEAD | grep "^apps/$app/VERSION" > /dev/null; then
              echo "VERSION updated for $app"
            else
              echo "ERROR: VERSION not updated for $app"
              exit 1
            fi
          done

      - name: Build Docker images
        run: |
          for app in ${{ steps.changes.outputs.apps }}; do
            docker build -t test-$app apps/$app
          done

      - name: Validate endpoints
        run: |
          PORT=9000
          for app in ${{ steps.changes.outputs.apps }}; do
            docker run -d -p $PORT:8001 --name test-$app test-$app

            sleep 10  

            curl -f http://localhost:$PORT/health
            curl -f http://localhost:$PORT/time

            docker stop test-$app
            docker rm test-$app

            PORT=$((PORT+1))
          done